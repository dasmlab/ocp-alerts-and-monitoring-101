apiVersion: apps/v1
kind: Deployment
metadata:
  name: alert-trigger-app
  namespace: demo-app
  labels:
    app: alert-trigger-app
    monitoring: enabled
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alert-trigger-app
  template:
    metadata:
      labels:
        app: alert-trigger-app
        monitoring: enabled
    spec:
      containers:
      - name: alert-trigger-app
        image: alert-trigger-app:latest
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: alert-trigger-app
  namespace: demo-app
  labels:
    app: alert-trigger-app
    monitoring: enabled
spec:
  selector:
    app: alert-trigger-app
  ports:
  - name: http
    port: 8080
    targetPort: http
    protocol: TCP
  type: ClusterIP

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: alert-trigger-app-monitor
  namespace: demo-app
  labels:
    app: alert-trigger-app
spec:
  selector:
    matchLabels:
      app: alert-trigger-app
      monitoring: enabled
  endpoints:
  - port: http
    interval: 30s
    path: /metrics
    scheme: http
    scrapeTimeout: 10s

---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: alert-trigger-demo-alerts
  namespace: demo-app
  labels:
    prometheus: user-workload
    role: alert-rules
spec:
  groups:
  - name: alert.trigger.demo
    rules:
    - alert: HighCPUUsageDemo
      expr: alert_demo_cpu_usage_percent > 80
      for: 1m
      labels:
        severity: warning
        component: cpu
      annotations:
        summary: "High CPU usage detected in demo app"
        description: "CPU usage is {{ $value }}% which is above the threshold of 80%"
    
    - alert: HighMemoryUsageDemo
      expr: alert_demo_memory_usage_percent > 90
      for: 1m
      labels:
        severity: warning
        component: memory
      annotations:
        summary: "High memory usage detected in demo app"
        description: "Memory usage is {{ $value }}% which is above the threshold of 90%"
    
    - alert: HighErrorRateDemo
      expr: alert_demo_error_rate_percent > 5
      for: 1m
      labels:
        severity: critical
        component: application
      annotations:
        summary: "High error rate detected in demo app"
        description: "Error rate is {{ $value }}% which is above the threshold of 5%"

